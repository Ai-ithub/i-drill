version: "3.9"

# Docker Compose configuration for connecting to remote services
# This configuration runs only the FastAPI application locally
# and connects to remote databases, Kafka, Redis, and MLflow services
#
# Usage: docker-compose -f docker-compose.remote.yml up

services:
  fastapi:
    build: .
    container_name: i-drill-fastapi-remote
    ports:
      - "8001:8001"
    working_dir: /src/backend
    command: uvicorn app:app --host 0.0.0.0 --port 8001
    environment:
      - PYTHONPATH=/src/backend
      - APP_ENV=production
      - SECRET_KEY=${SECRET_KEY:-dev-secret-change-me}
      - ALLOWED_ORIGINS=${ALLOWED_ORIGINS:-http://localhost:5173}
      - RATE_LIMIT_DEFAULT=200/minute
      
      # Remote Database Configuration
      - DATABASE_URL=${DATABASE_URL:-postgresql://user:pass@remote-db.example.com:5432/drilling_db}
      
      # Remote Redis Configuration
      - REDIS_HOST=${REDIS_HOST:-remote-redis.example.com}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      
      # Remote Kafka Configuration
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-remote-kafka.example.com:9092}
      - KAFKA_SENSOR_TOPIC=${KAFKA_SENSOR_TOPIC:-rig.sensor.stream}
      - KAFKA_GROUP_ID=${KAFKA_GROUP_ID:-api-consumer-group}
      
      # Kafka Authentication (if enabled)
      - KAFKA_SECURITY_PROTOCOL=${KAFKA_SECURITY_PROTOCOL:-}
      - KAFKA_SASL_MECHANISM=${KAFKA_SASL_MECHANISM:-}
      - KAFKA_SASL_USERNAME=${KAFKA_SASL_USERNAME:-}
      - KAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD:-}
      
      # Remote MLflow Configuration
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-http://remote-mlflow.example.com:5000}
      - MLFLOW_EXPERIMENT_NAME=${MLFLOW_EXPERIMENT_NAME:-i-drill-models}
      
    volumes:
      - ./src:/src
      - ./models:/models
    # No depends_on - connecting to remote services
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Optional: Local producer for testing (connects to remote Kafka)
  producer:
    build: .
    container_name: i-drill-producer-remote
    working_dir: /src/backend
    command: python Producer.py
    environment:
      - PYTHONPATH=/src/backend
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-remote-kafka.example.com:9092}
      - KAFKA_SECURITY_PROTOCOL=${KAFKA_SECURITY_PROTOCOL:-}
      - KAFKA_SASL_MECHANISM=${KAFKA_SASL_MECHANISM:-}
      - KAFKA_SASL_USERNAME=${KAFKA_SASL_USERNAME:-}
      - KAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD:-}
    volumes:
      - ./src:/src
    restart: on-failure
    depends_on:
      - fastapi

  # Optional: Local consumer for testing (connects to remote Kafka)
  consumer:
    build: .
    container_name: i-drill-consumer-remote
    working_dir: /src/backend
    command: python Consumer.py
    environment:
      - PYTHONPATH=/src/backend
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-remote-kafka.example.com:9092}
      - KAFKA_SECURITY_PROTOCOL=${KAFKA_SECURITY_PROTOCOL:-}
      - KAFKA_SASL_MECHANISM=${KAFKA_SASL_MECHANISM:-}
      - KAFKA_SASL_USERNAME=${KAFKA_SASL_USERNAME:-}
      - KAFKA_SASL_PASSWORD=${KAFKA_SASL_PASSWORD:-}
    volumes:
      - ./src:/src
    restart: on-failure
    depends_on:
      - fastapi

