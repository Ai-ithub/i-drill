name: MLOps - Model Training

on:
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type to train'
        required: true
        type: choice
        options:
          - ppo
          - sac
          - lstm
          - transformer
          - cnn_lstm
      experiment_name:
        description: 'MLflow experiment name'
        required: false
        default: 'i-drill-training'
      total_timesteps:
        description: 'Total training timesteps (for RL models)'
        required: false
        default: '100000'
      epochs:
        description: 'Training epochs (for DL models)'
        required: false
        default: '50'
  schedule:
    # Weekly training on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  push:
    branches:
      - main
      - develop
    paths:
      - 'src/drilling_env/**'
      - 'src/rul_prediction/**'
      - 'train_*.py'
      - 'Scripts/train*.py'

jobs:
  train:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements/ml.txt
          pip install mlflow
      
      - name: Set up MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          MLFLOW_EXPERIMENT_NAME: ${{ github.event.inputs.experiment_name || 'i-drill-training' }}
        run: |
          echo "MLflow tracking URI: $MLFLOW_TRACKING_URI"
          echo "Experiment name: $MLFLOW_EXPERIMENT_NAME"
      
      - name: Train PPO Model
        if: github.event.inputs.model_type == 'ppo' || (github.event_name == 'schedule' && github.event.inputs.model_type == '')
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          TOTAL_TIMESTEPS: ${{ github.event.inputs.total_timesteps || '100000' }}
        run: |
          python train_ppo.py --total_timesteps $TOTAL_TIMESTEPS
      
      - name: Train SAC Model
        if: github.event.inputs.model_type == 'sac'
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          TOTAL_TIMESTEPS: ${{ github.event.inputs.total_timesteps || '100000' }}
        run: |
          python train_sac.py --total_timesteps $TOTAL_TIMESTEPS
      
      - name: Train LSTM Model
        if: github.event.inputs.model_type == 'lstm'
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          EPOCHS: ${{ github.event.inputs.epochs || '50' }}
        run: |
          cd src/rul_prediction
          python main.py --mode train --model_type lstm --epochs $EPOCHS
      
      - name: Train Transformer Model
        if: github.event.inputs.model_type == 'transformer'
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          EPOCHS: ${{ github.event.inputs.epochs || '50' }}
        run: |
          cd src/rul_prediction
          python main.py --mode train --model_type transformer --epochs $EPOCHS
      
      - name: Train CNN-LSTM Model
        if: github.event.inputs.model_type == 'cnn_lstm'
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          EPOCHS: ${{ github.event.inputs.epochs || '50' }}
        run: |
          cd src/rul_prediction
          python main.py --mode train --model_type cnn_lstm --epochs $EPOCHS
      
      - name: Log training to MLflow
        if: always()
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
        run: |
          MODEL_TYPE=${{ github.event.inputs.model_type || 'ppo' }}
          MODEL_NAME="${MODEL_TYPE}_drilling_env"
          EXPERIMENT=${{ github.event.inputs.experiment_name || 'i-drill-training' }}
          
          if [ -d "./models/${MODEL_TYPE}" ]; then
            python Scripts/log_training_to_mlflow.py \
              --model_type $MODEL_TYPE \
              --model_name $MODEL_NAME \
              --model_path ./models/$MODEL_TYPE \
              --experiment $EXPERIMENT
          else
            echo "Model directory not found, skipping MLflow logging"
          fi
      
      - name: Evaluate Model
        if: always()
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
        run: |
          MODEL_TYPE=${{ github.event.inputs.model_type || 'ppo' }}
          if [ -d "./models/${MODEL_TYPE}" ]; then
            python Scripts/evaluate_model.py \
              --model_dir ./models/$MODEL_TYPE \
              --experiment ${{ github.event.inputs.experiment_name || 'i-drill-training' }}
          fi
      
      - name: Upload model artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trained-model-${{ github.event.inputs.model_type || 'ppo' }}
          path: |
            models/${{ github.event.inputs.model_type || 'ppo' }}/
          retention-days: 30
      
      - name: Trigger validation workflow
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'mlops-validate.yml',
              ref: context.ref,
              inputs: {
                model_name: '${{ github.event.inputs.model_type || "ppo" }}_drilling_env',
                model_type: '${{ github.event.inputs.model_type || "ppo" }}'
              }
            });
