name: MLOps - Model Training Pipeline

on:
  workflow_dispatch:
    inputs:
      model_type:
        description: 'Model type to train'
        required: true
        type: choice
        options:
          - ppo
          - sac
          - lstm
          - transformer
          - cnn_lstm
      training_config:
        description: 'Training configuration (JSON)'
        required: false
        type: string
        default: '{}'
      experiment_name:
        description: 'MLflow experiment name'
        required: false
        type: string
        default: 'i-drill-training'
  schedule:
    # Train models weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  push:
    branches:
      - main
      - develop
    paths:
      - 'i-drill/src/drilling_env/**'
      - 'i-drill/train_*.py'
      - 'i-drill/hyperparameter_tuning.py'
      - '.github/workflows/mlops-train.yml'

env:
  PYTHON_VERSION: '3.11'
  MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
  MLFLOW_EXPERIMENT_NAME: ${{ github.event.inputs.experiment_name || 'i-drill-training' }}

jobs:
  validate-training-request:
    name: Validate Training Request
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./i-drill
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate model type
        run: |
          MODEL_TYPE="${{ github.event.inputs.model_type }}"
          if [ -z "$MODEL_TYPE" ]; then
            echo "‚ùå Model type is required"
            exit 1
          fi
          
          VALID_TYPES="ppo sac lstm transformer cnn_lstm"
          if [[ ! " $VALID_TYPES " =~ " $MODEL_TYPE " ]]; then
            echo "‚ùå Invalid model type: $MODEL_TYPE"
            exit 1
          fi
          
          echo "‚úÖ Model type validated: $MODEL_TYPE"
          echo "MODEL_TYPE=$MODEL_TYPE" >> $GITHUB_ENV
      
      - name: Set training config
        id: config
        run: |
          CONFIG='${{ github.event.inputs.training_config }}'
          if [ "$CONFIG" == "{}" ]; then
            CONFIG='{"total_timesteps": 100000, "evaluation_interval": 10000}'
          fi
          echo "config=$CONFIG" >> $GITHUB_OUTPUT

  train-model:
    name: Train ${{ github.event.inputs.model_type || 'Model' }}
    runs-on: ubuntu-latest
    needs: validate-training-request
    defaults:
      run:
        working-directory: ./i-drill
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - model: ppo
            gpu: false
          - model: sac
            gpu: false
          - model: lstm
            gpu: true
          - model: transformer
            gpu: true
          - model: cnn_lstm
            gpu: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: ./i-drill/requirements.txt
      
      - name: Set up CUDA (if GPU required)
        if: matrix.gpu == true
        uses: Jimver/cuda-toolkit@v0.2.11
        with:
          cuda: '11.8.0'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements/ml.txt
          pip install mlflow[extras] pytest-cov
      
      - name: Wait for MLflow server
        run: |
          echo "Waiting for MLflow server to be ready..."
          timeout 300 bash -c '
            until curl -f ${{ env.MLFLOW_TRACKING_URI }}/health 2>/dev/null; do
              echo "Waiting for MLflow..."
              sleep 5
            done
          ' || echo "MLflow server may not be available (continuing anyway)"
      
      - name: Set environment variables
        run: |
          echo "MLFLOW_TRACKING_URI=${{ env.MLFLOW_TRACKING_URI }}" >> $GITHUB_ENV
          echo "MLFLOW_EXPERIMENT_NAME=${{ env.MLFLOW_EXPERIMENT_NAME }}" >> $GITHUB_ENV
          echo "MODEL_TYPE=${{ github.event.inputs.model_type || matrix.model }}" >> $GITHUB_ENV
          echo "TRAINING_CONFIG=${{ needs.validate-training-request.outputs.config }}" >> $GITHUB_ENV
      
      - name: Run model training
        id: train
        run: |
          MODEL_TYPE="$MODEL_TYPE"
          
          case $MODEL_TYPE in
            ppo|sac)
              echo "üöÄ Training $MODEL_TYPE model..."
              python train_${MODEL_TYPE}.py
              MODEL_NAME="${MODEL_TYPE}_drilling_env"
              ;;
            lstm|transformer|cnn_lstm)
              echo "üöÄ Training $MODEL_TYPE RUL model..."
              python -m src.predictive_maintenance.train \
                --model_type $MODEL_TYPE \
                --config "$TRAINING_CONFIG"
              MODEL_NAME="rul_${MODEL_TYPE}"
              ;;
            *)
              echo "‚ùå Unknown model type: $MODEL_TYPE"
              exit 1
              ;;
          esac
          
          echo "MODEL_NAME=$MODEL_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Training completed for $MODEL_NAME"
      
      - name: Log training artifacts to MLflow
        if: success()
        run: |
          echo "üì¶ Logging training artifacts to MLflow..."
          python scripts/log_training_to_mlflow.py \
            --model_type "$MODEL_TYPE" \
            --model_name "${{ steps.train.outputs.MODEL_NAME }}" \
            --experiment "$MLFLOW_EXPERIMENT_NAME" || echo "‚ö†Ô∏è MLflow logging failed (non-critical)"
      
      - name: Upload training logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: training-logs-${{ matrix.model }}-${{ github.run_id }}
          path: |
            i-drill/*.log
            i-drill/logs/**
          retention-days: 30
      
      - name: Upload model artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: model-${{ steps.train.outputs.MODEL_NAME }}-${{ github.run_id }}
          path: |
            i-drill/*${MODEL_TYPE}*drilling_env*
            i-drill/models/**
          retention-days: 90

  evaluate-model:
    name: Evaluate Trained Model
    runs-on: ubuntu-latest
    needs: train-model
    if: always()
    defaults:
      run:
        working-directory: ./i-drill
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: model-*
          merge-multiple: true
          path: ./models
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements/ml.txt
      
      - name: Run model evaluation
        id: evaluate
        run: |
          echo "üß™ Evaluating trained models..."
          python scripts/evaluate_model.py \
            --model_dir ./models \
            --experiment "$MLFLOW_EXPERIMENT_NAME" || echo "‚ö†Ô∏è Evaluation failed"
      
      - name: Check model quality
        run: |
          echo "üìä Checking model quality metrics..."
          python scripts/check_model_quality.py || exit 1
      
      - name: Upload evaluation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evaluation-results-${{ github.run_id }}
          path: |
            i-drill/evaluation_results/**
            i-drill/reports/**
          retention-days: 90

  register-model:
    name: Register Model in MLflow
    runs-on: ubuntu-latest
    needs: [train-model, evaluate-model]
    if: success()
    defaults:
      run:
        working-directory: ./i-drill
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download model artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: model-*
          merge-multiple: true
          path: ./models
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install mlflow[extras]
      
      - name: Register model in MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
          MLFLOW_EXPERIMENT_NAME: ${{ env.MLFLOW_EXPERIMENT_NAME }}
        run: |
          echo "üìù Registering model in MLflow..."
          python scripts/register_model.py \
            --model_dir ./models \
            --experiment "$MLFLOW_EXPERIMENT_NAME" \
            --stage "Staging" || echo "‚ö†Ô∏è Model registration failed"
      
      - name: Create model summary
        if: success()
        run: |
          echo "üìã Creating model summary..."
          python scripts/create_model_summary.py > model_summary.md
      
      - name: Upload model summary
        uses: actions/upload-artifact@v4
        with:
          name: model-summary-${{ github.run_id }}
          path: model_summary.md
          retention-days: 365

  notify-completion:
    name: Notify Training Completion
    runs-on: ubuntu-latest
    needs: [train-model, evaluate-model, register-model]
    if: always()
    
    steps:
      - name: Notify success
        if: success()
        run: |
          echo "‚úÖ Model training pipeline completed successfully!"
          echo "Model: ${{ github.event.inputs.model_type }}"
          echo "Run ID: ${{ github.run_id }}"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "‚ùå Model training pipeline failed!"
          echo "Model: ${{ github.event.inputs.model_type }}"
          echo "Run ID: ${{ github.run_id }}"
          exit 1

