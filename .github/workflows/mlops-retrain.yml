name: MLOps - Automated Retraining

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: 'Model name to check for retraining'
        required: true
        default: 'ppo_drilling_env'
      auto_trigger:
        description: 'Automatically trigger training if conditions met'
        required: false
        default: 'false'
        type: boolean
  schedule:
    # Daily check at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  check-retraining:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements/ml.txt
          pip install mlflow scikit-learn scipy pandas numpy pyyaml
      
      - name: Set up MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
        run: |
          echo "MLflow tracking URI: $MLFLOW_TRACKING_URI"
      
      - name: Check Retraining Conditions
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI || 'http://localhost:5000' }}
          MODEL_NAME: ${{ github.event.inputs.model_name || 'ppo_drilling_env' }}
          AUTO_TRIGGER: ${{ github.event.inputs.auto_trigger || 'false' }}
        run: |
          python Scripts/trigger_retraining.py \
            --model_name $MODEL_NAME \
            --config config/mlops_config.yaml \
            $([ "$AUTO_TRIGGER" == "true" ] && echo "--auto-trigger" || echo "--check-only")
      
      - name: Trigger Training Workflow
        if: success() && env.RETRAIN_NEEDED == 'true'
        uses: actions/github-script@v7
        env:
          MODEL_NAME: ${{ github.event.inputs.model_name || 'ppo_drilling_env' }}
        with:
          script: |
            // Determine model type from model name
            const modelName = process.env.MODEL_NAME;
            let modelType = 'ppo';
            
            if (modelName.includes('sac')) {
              modelType = 'sac';
            } else if (modelName.includes('lstm')) {
              modelType = 'lstm';
            } else if (modelName.includes('transformer')) {
              modelType = 'transformer';
            } else if (modelName.includes('cnn_lstm')) {
              modelType = 'cnn_lstm';
            }
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'mlops-train.yml',
              ref: context.ref,
              inputs: {
                model_type: modelType,
                experiment_name: 'auto-retraining'
              }
            });
            
            console.log(`Triggered training workflow for ${modelType}`);
